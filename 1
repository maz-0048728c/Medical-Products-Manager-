// Flutter app for Medical Products Manager
// Features: Medicine tracker, password lock, expiry alert, backup-ready structure
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:async';

void main() {
  runApp(const MedicalProductsManager());
}

class MedicalProductsManager extends StatelessWidget {
  const MedicalProductsManager({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Medical Products Manager',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
      ),
      home: const PasswordGate(),
    );
  }
}

class PasswordGate extends StatefulWidget {
  const PasswordGate({super.key});

  @override
  State<PasswordGate> createState() => _PasswordGateState();
}

class _PasswordGateState extends State<PasswordGate> {
  final _passwordController = TextEditingController();
  String? savedPassword;

  @override
  void initState() {
    super.initState();
    _loadPassword();
  }

  Future<void> _loadPassword() async {
    final prefs = await SharedPreferences.getInstance();
    setState(() {
      savedPassword = prefs.getString('app_password');
    });
  }

  Future<void> _savePassword(String password) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('app_password', password);
    setState(() => savedPassword = password);
  }

  void _checkPassword() {
    if (_passwordController.text == savedPassword) {
      Navigator.pushReplacement(
          context, MaterialPageRoute(builder: (_) => const MedicineHome()));
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Incorrect password')));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.blue.shade50,
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Card(
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
            elevation: 8,
            child: Padding(
              padding: const EdgeInsets.all(24.0),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Text('Medical Products Manager',
                      style:
                          TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 20),
                  if (savedPassword == null) ...[
                    const Text('Set your app password:'),
                    TextField(
                      controller: _passwordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'New Password', icon: Icon(Icons.lock)),
                    ),
                    const SizedBox(height: 20),
                    ElevatedButton(
                        onPressed: () {
                          _savePassword(_passwordController.text);
                        },
                        child: const Text('Save Password'))
                  ] else ...[
                    const Text('Enter your password:'),
                    TextField(
                      controller: _passwordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Password', icon: Icon(Icons.lock)),
                    ),
                    const SizedBox(height: 20),
                    ElevatedButton(
                        onPressed: _checkPassword,
                        child: const Text('Unlock App'))
                  ]
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class MedicineHome extends StatefulWidget {
  const MedicineHome({super.key});

  @override
  State<MedicineHome> createState() => _MedicineHomeState();
}

class _MedicineHomeState extends State<MedicineHome> {
  final List<Map<String, dynamic>> _medicines = [];
  final TextEditingController _nameCtrl = TextEditingController();
  DateTime? _expiryDate;
  int expiringSoonDays = 60;

  void _addMedicine() {
    if (_nameCtrl.text.isEmpty || _expiryDate == null) return;

    setState(() {
      _medicines.add({
        'name': _nameCtrl.text,
        'expiry': _expiryDate!,
      });
    });

    _nameCtrl.clear();
    _expiryDate = null;
  }

  void _openSettings() {
    showDialog(
      context: context,
      builder: (_) {
        final ctrl = TextEditingController(text: expiringSoonDays.toString());
        return AlertDialog(
          title: const Text('Settings'),
          content: TextField(
            controller: ctrl,
            decoration: const InputDecoration(
                labelText: 'Days before expiry to mark as expiring soon'),
            keyboardType: TextInputType.number,
          ),
          actions: [
            TextButton(
                onPressed: () {
                  setState(() => expiringSoonDays = int.parse(ctrl.text));
                  Navigator.pop(context);
                },
                child: const Text('Save'))
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Medical Products Manager'),
        actions: [
          IconButton(onPressed: _openSettings, icon: const Icon(Icons.settings))
        ],
      ),
      body: _medicines.isEmpty
          ? const Center(child: Text('No medicines added yet.'))
          : ListView.builder(
              itemCount: _medicines.length,
              itemBuilder: (context, i) {
                final med = _medicines[i];
                final daysLeft =
                    med['expiry'].difference(DateTime.now()).inDays;
                Color borderColor = Colors.green;
                if (daysLeft <= 0) borderColor = Colors.red;
                else if (daysLeft <= expiringSoonDays) borderColor = Colors.orange;

                return Card(
                  margin:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  shape: RoundedRectangleBorder(
                      side: BorderSide(color: borderColor, width: 2),
                      borderRadius: BorderRadius.circular(12)),
                  child: ListTile(
                    title: Text(med['name']),
                    subtitle: Text(
                        'Expiry: ${med['expiry'].toLocal().toString().split(' ')[0]}\nDays left: $daysLeft'),
                    isThreeLine: true,
                  ),
                );
              }),
      floatingActionButton: FloatingActionButton(
        backgroundColor: Colors.red,
        onPressed: () async {
          await showDialog(
            context: context,
            builder: (_) => AlertDialog(
              title: const Text('Add Medicine'),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  TextField(
                    controller: _nameCtrl,
                    decoration:
                        const InputDecoration(labelText: 'Medicine Name'),
                  ),
                  const SizedBox(height: 10),
                  ElevatedButton(
                    onPressed: () async {
                      final picked = await showDatePicker(
                        context: context,
                        firstDate: DateTime.now(),
                        lastDate: DateTime(2100),
                        initialDate: DateTime.now(),
                      );
                      if (picked != null) {
                        setState(() => _expiryDate = picked);
                      }
                    },
                    child: Text(_expiryDate == null
                        ? 'Select Expiry Date'
                        : 'Expiry: ${_expiryDate!.toLocal().toString().split(' ')[0]}'),
                  )
                ],
              ),
              actions: [
                TextButton(
                    onPressed: () {
                      _addMedicine();
                      Navigator.pop(context);
                    },
                    child: const Text('Add'))
              ],
            ),
          );
        },
        child: const Icon(Icons.add, color: Colors.white),
      ),
    );
  }
}
